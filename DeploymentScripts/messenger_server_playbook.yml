---
- hosts: messenger_servers
  vars_files:
   - cert_vault.yml
   - passwords_vault.yml
  vars:
   - prosody_conf_path: /etc/prosody/prosody.cfg.lua
   - monitron_site_conf_path: "/etc/prosody/conf.d/{{domain_name}}.cfg.lua"
   - pki_path: /etc/pki/prosody/
   - prosody_module_path: /usr/lib64/prosody/modules/
  tasks:
   - name: Install Prosody
     dnf: name=prosody state=latest
     notify:
      - Enable Prosody
      - Start Prosody

   - name: Upload Prosody server configuration
     template: src=prosody.cfg.lua dest={{prosody_conf_path}} mode=640 owner=root group=prosody
     notify:
      - Restart Prosody

   - name: Upload Monitron site configuration
     template: src=prosody_site.cfg.lua dest={{monitron_site_conf_path}} mode=640 owner=root group=prosody
     notify:
      - Restart Prosody

   - name: Upload Monitron site cert (crt)
     copy:
      content: "{{ monitron_cert_crt }}"
      dest: "{{pki_path}}/{{domain_name}}.crt"
      mode: 0644
      owner: root
      group: root
     notify:
      - Restart Prosody

   - name: Upload Monitron site cert (key)
     copy:
      content: "{{ monitron_cert_key }}"
      dest: "{{pki_path}}/{{domain_name}}.key"
      mode: 0640
      owner: root
      group: prosody
     notify:
      - Restart Prosody

   - name: Upload Monitron site cert (cnf)
     copy:
      content: "{{ monitron_cert_cnf }}"
      dest: "{{pki_path}}/{{domain_name}}.cnf"
      mode: 0640
      owner: root
      group: prosody
     notify:
      - Restart Prosody

   - name: Upload Monitron Ad-Hoc module
     copy: src=mod_monitron_adhoc.lua dest={{prosody_module_path}} mode=644 owner=root group=root
     notify:
      - Restart Prosody

   - name: Create Monitron admin
     script: "./prosody_adduser.sh 'monitron_admin@{{domain_name}}' '{{monitron_admin_password}}'"

   - name: Create Server admin
     script: "./prosody_adduser.sh 'admin@{{domain_name}}' '{{admin_password}}'"

   - name: Create Management user
     script: "./prosody_adduser.sh 'themanagement@{{domain_name}}' '{{monitron_management_password}}'"

  handlers:
   - name: Enable Prosody
     service: name=prosody enabled=yes
   - name: Start Prosody
     service: name=prosody state=started
   - name: Restart Prosody
     service: name=prosody state=restarted
